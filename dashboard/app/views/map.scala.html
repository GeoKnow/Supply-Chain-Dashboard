@()

@header = {
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <style type="text/css">
    html { height: 99% }
    body { height: 99%; margin: 0; padding: 0 }
    #wrapper {
      height: 99%;
      border: 1px solid black;
    }
    #filter-widget {
      height: 99%;
      width: 25%;
      float: left;
      border: 1px solid green;
    }
    #map-widget {
      height: 99%;
      width: 50%;
      float: left;
      border: 1px solid red;
    }
    #property-widget {
      height: 99%;
      width: 24%;
      float: left;
      border: 1px solid blue;
    }
  </style>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCX5mXDIbz7VKQyGbDcwGD5PuK4-ioid8w&sensor=false" ></script>
  <script type="text/javascript">
    var map = null // Set during initialization

    function initialize() {
      // Initialize map
      var mapOptions = {
        center: new google.maps.LatLng(52.423, 10.787),
        zoom: 8,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById("map-widget"), mapOptions)

      //Draw addresses
      showAddresses()
    }

    function showAddresses() {
      $.get("/map/addresses", function(data) {
        // Remove existing address markers
        if (typeof addressMarkers !== 'undefined') {
          for (var i = 0; i < addressMarkers.length; i++) {
            addressMarkers[i].setMap(null);
          }
          addressMarkers = [];
        }
        // Load new address markers
        jQuery.globalEval(data);
        // Add all address markers to the map
        for (var i = 0; i < addressMarkers.length; i++) {
          //google.maps.event.addListener(addressMarkers[i], 'click', function(event) { showDeliveries(address.id) })
          addressMarkers[i].setMap(map);
        }
      })
    }

    function showDeliveries(addressId) {
      $.get("/map/deliveries?addressId=" + addressId, function(data) {
        // Remove existing delivery lines
        if (typeof deliveryLines !== 'undefined') {
          for (var i = 0; i < deliveryLines.length; i++) {
            deliveryLines[i].setMap(null);
          }
          deliveryLines = [];
        }
        // Load new delivery lines
        jQuery.globalEval(data);
        // Add all lines to the map
        for (var i = 0; i < deliveryLines.length; i++) {
          deliveryLines[i].setMap(map);
        }
      })
    }

    function selectAddress(addressId) {
      showDeliveries(addressId)
      $.get("/address/" + addressId, function(data) {
        $('#property-widget' ).html(data)
      })
    }

    function selectDelivery(deliveryId) {
      $.get("/delivery/" + deliveryId, function(data) {
        $('#property-widget' ).html(data)
      })
    }

    google.maps.event.addDomListener(window, 'load', initialize);
  </script>
}

@content = {
  <div id="wrapper">
    <div id="filter-widget">
      Filter
    </div>
    <div id="map-widget" >
      Could not load map!
    </div>
    <div id="property-widget">
      Select address for details.
    </div>
  </div>
}

@main("Supply Chain Dashboard")(header)(content)